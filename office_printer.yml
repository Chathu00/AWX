- name: Reusable Office Printer Setup
  hosts: windows_host
  gather_facts: no

  vars_prompt:
    - name: printer_name
      prompt: "Enter the printer name"
      private: no
    - name: printer_ip
      prompt: "Enter the printer IP address"
      private: no
    - name: printer_driver_name
      prompt: "Enter the printer driver name (default: Microsoft Print to PDF)"
      private: no
      default: "Microsoft Print to PDF"

  tasks:

    - name: Check if Printer Exists
      win_shell: |
        $printer = Get-Printer -Name "{{ printer_name }}" -ErrorAction SilentlyContinue
        if ($printer) { Write-Output "Exists" } else { Write-Output "NotExists" }
      register: printer_status

    - name: Set Printer Exists Fact
      set_fact:
        printer_exists: "{{ 'Exists' in printer_status.stdout }}"

    - name: Get Existing Printer Ports
      win_shell: Get-PrinterPort | Select-Object -ExpandProperty Name
      register: printer_ports

    - name: Set Port Exists Fact
      set_fact:
        port_exists: "{{ printer_ip in printer_ports.stdout_lines }}"

    - name: Add Printer Port (if not exists)
      win_shell: Add-PrinterPort -Name "{{ printer_ip }}" -PrinterHostAddress "{{ printer_ip }}"
      when: not port_exists
      register: port_add_result

    - name: ‚úÖ Printer Port Added
      debug:
        msg: "‚úÖ Printer port '{{ printer_ip }}' added successfully."
      when: not port_exists and port_add_result.rc == 0

    - name: Add Printer (if not exists)
      win_shell: |
        Add-Printer -Name "{{ printer_name }}" -PortName "{{ printer_ip }}" -DriverName "{{ printer_driver_name }}"
      when: not printer_exists
      register: printer_add_result
      ignore_errors: true

    - name: ‚úÖ Printer Added Successfully
      debug:
        msg: "üñ®Ô∏è Printer '{{ printer_name }}' added successfully."
      when: not printer_exists and printer_add_result.rc == 0

    - name: ‚ö†Ô∏è Printer Already Exists
      debug:
        msg: "‚ö†Ô∏è Printer '{{ printer_name }}' already exists. Skipping add."
      when: printer_exists

    - name: Set Default Printer
      win_shell: |
        $printer = Get-Printer -Name "{{ printer_name }}" -ErrorAction SilentlyContinue
        if ($printer) {
          (New-Object -ComObject WScript.Network).SetDefaultPrinter("{{ printer_name }}")
          Write-Output "‚úÖ Default printer set to '{{ printer_name }}'"
        }
      register: default_set
      ignore_errors: true

    - name: ‚úÖ Default Printer Set
      debug:
        msg: "{{ default_set.stdout }}"
      when: default_set.stdout is defined and default_set.stdout != ""

    - name: Restart Print Spooler Service
      win_shell: Restart-Service Spooler
      register: spooler_restart
      ignore_errors: yes

    - name: üîÑ Spooler Restarted
      debug:
        msg: "üîÑ Print Spooler service restarted successfully."
      when: spooler_restart.rc == 0
