- name: Office Printer Automation
  hosts: windows_host
  gather_facts: no

  vars:
    printer_name: "OfficePrinter1"
    printer_ip: "192.168.1.50"  # Replace with your actual printer IP
    driver_path: "C:\\Path\\To\\Driver.inf"  # Replace with actual INF path

  tasks:

    - name: ğŸ” Get Wi-Fi Connection Details
      win_shell: |
        (Get-NetAdapter -InterfaceDescription "*Wireless*").InterfaceAlias
      register: wifi_status
      ignore_errors: yes

    - name: â„¹ï¸ Show Wi-Fi Connection Status
      debug:
        msg: "Connected to Wi-Fi: {{ wifi_status.stdout }}"
      when: wifi_status.stdout | length > 0

    - name: ğŸ” Get Printer Ports
      win_shell: Get-PrinterPort | Select-Object -ExpandProperty Name
      register: printer_ports

    - name: â„¹ï¸ Check if Printer IP is in Configured Ports
      debug:
        msg: "âœ… Printer IP {{ printer_ip }} is already configured."
      when: printer_ip in printer_ports.stdout_lines

    - name: â• Add Printer Port (If Missing)
      win_shell: |
        Add-PrinterPort -Name "{{ printer_ip }}" -PrinterHostAddress "{{ printer_ip }}"
      when: printer_ip not in printer_ports.stdout_lines

    - name: ğŸ”§ Install Printer Driver
      win_shell: |
        pnputil /add-driver "{{ driver_path }}" /install
      register: driver_install_result
      ignore_errors: yes

    - name: â„¹ï¸ Show Driver Installation Output
      debug:
        msg: "{{ driver_install_result.stdout_lines }}"

    - name: ğŸ–¨ï¸ Add Printer with IP
      win_shell: |
        Add-Printer -Name "{{ printer_name }}" -PortName "{{ printer_ip }}" -DriverName "Your Printer Driver Name Here"
      register: printer_install_result
      ignore_errors: yes

    - name: â„¹ï¸ Printer Install Result
      debug:
        msg: "Printer '{{ printer_name }}' installed on IP {{ printer_ip }}"

    - name: âœ… Set Default Printer (via registry)
      win_shell: |
        Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Windows" -Name "Device" -Value "{{ printer_name }},winspool,Ne00:"
      register: set_default_result
      ignore_errors: yes

    - name: ğŸ”§ Get Default Printer
      win_shell: |
        (Get-Printer | Where-Object { $_.IsDefault -eq $true }).Name
      register: default_printer

    - name: â„¹ï¸ Default Printer Status
      debug:
        msg: "ğŸ–¨ï¸ Current Default Printer: {{ default_printer.stdout }}"

    - name: ğŸ§¹ Find Stuck Print Jobs
      win_shell: |
        Get-Printer | ForEach-Object {
          Get-PrintJob -PrinterName $_.Name | Where-Object { $_.JobStatus -match "Error" }
        }
      register: stuck_jobs

    - name: ğŸ§½ Remove Stuck Print Jobs
      win_shell: |
        Get-Printer | ForEach-Object {
          Get-PrintJob -PrinterName $_.Name | Where-Object { $_.JobStatus -match "Error" } | ForEach-Object {
            Remove-PrintJob -PrinterName $_.Name -ID $_.ID
          }
        }
      when: stuck_jobs.stdout | length > 0

    - name: ğŸ’¾ Save Stuck Print Jobs to XML (if any)
      win_shell: |
        $outputPath = "C:\\Users\\Public\\Documents\\FailedPrintJobs\\StuckJobs.xml"
        $stuckJobs = Get-Printer | ForEach-Object {
          Get-PrintJob -PrinterName $_.Name | Where-Object { $_.JobStatus -match "Error" }
        }
        if ($stuckJobs) {
          $stuckJobs | Export-Clixml -Path $outputPath
        }
      when: stuck_jobs.stdout | length > 0

    - name: â„¹ï¸ Stuck Jobs Removed and Saved
      debug:
        msg: "ğŸš€ Stuck print jobs removed. Saved at C:\\Users\\Public\\Documents\\FailedPrintJobs\\StuckJobs.xml"

    - name: ğŸ”„ Check Printer Online Status
      win_shell: |
        (Get-Printer -Name "{{ printer_name }}").PrinterStatus
      register: printer_status

    - name: ğŸ”§ Restart Spooler if Offline
      win_shell: Restart-Service Spooler
      when: "'Offline' in printer_status.stdout"

    - name: âœ… Final Printer Online Status
      debug:
        msg: "Printer '{{ printer_name }}' is now online."
